name: Fix CSS-module & Deploy Next.js to GitHub Pages

on:
  push:
    branches: ["main"]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Prepare project (install raw-loader, add next.config, add injector, patch layout)
        shell: bash
        run: |
          set -euo pipefail

          # Adjust this to your actual Next.js project folder if different
          PROJECT_DIR="smart-crop-adviser/smart-crop-adviser/smart-crop-adviser"
          echo "Project dir: $PROJECT_DIR"

          if [ ! -d "$PROJECT_DIR" ]; then
            echo "ERROR: project dir does not exist: $PROJECT_DIR"
            echo "Repo top-level files:"
            ls -la
            exit 1
          fi

          cd "$PROJECT_DIR"

          echo "Installing raw-loader as a dev dependency for the runner..."
          # install dev dependency locally in the runner
          npm install --no-audit --no-fund --save-dev raw-loader

          echo "Writing next.config.js to treat home.module.css as raw text..."
          cat > next.config.js <<'JS'
module.exports = {
  webpack: (config) => {
    config.module.rules.push({
      test: /[\\/]src[\\/]app[\\/]home\.module\.css$/,
      use: [
        {
          loader: require.resolve('raw-loader'),
        },
      ],
    });
    return config;
  },
};
JS

          echo "Creating injector component at src/components/InjectHomeCss.jsx..."
          mkdir -p src/components

          cat > src/components/InjectHomeCss.jsx <<'JSX'
'use client';

import { useEffect } from 'react';
import cssText from '../app/home.module.css';

export default function InjectHomeCss() {
  useEffect(() => {
    if (typeof document === 'undefined') return;
    const ID = 'injected-home-module-css';
    if (document.getElementById(ID)) return;

    const style = document.createElement('style');
    style.id = ID;
    style.type = 'text/css';
    style.appendChild(document.createTextNode(cssText));
    document.head.appendChild(style);
  }, []);

  return null;
}
JSX

          LAYOUT_FILE="src/app/layout.js"
          if [ -f "$LAYOUT_FILE" ]; then
            echo "Patching layout file: $LAYOUT_FILE"

            # Remove any direct import of home.module.css
            # and add the injector import if missing.
            # This is conservative and will not overwrite unrelated lines.
            cp "$LAYOUT_FILE" "${LAYOUT_FILE}.bak"

            # Remove any lines importing home.module.css
            sed -i "/home.module.css/d" "$LAYOUT_FILE" || true

            # Add injector import if not present
            if ! grep -q "InjectHomeCss" "$LAYOUT_FILE"; then
              # find the last import line number to insert after imports
              last_import_line=$(nl -ba "$LAYOUT_FILE" | grep -n "^ *import " | tail -n1 | awk -F: '{print $1}' || echo 0)
              if [ "$last_import_line" -gt 0 ]; then
                awk -v n="$last_import_line" 'NR==n{print; print "import InjectHomeCss from \'../components/InjectHomeCss\';"; next} NR!=n{print}' "$LAYOUT_FILE" > "${LAYOUT_FILE}.tmp" && mv "${LAYOUT_FILE}.tmp" "$LAYOUT_FILE"
              else
                # no imports found, add at top
                sed -i "1s;^;import InjectHomeCss from '../components/InjectHomeCss';\n;" "$LAYOUT_FILE"
              fi
            fi

            # Insert <InjectHomeCss /> immediately after opening <body ...> tag if not present
            if ! grep -q "<InjectHomeCss" "$LAYOUT_FILE"; then
              sed -i "s|<body\\(.*\\)>|<body\\1>\\n        <InjectHomeCss />|g" "$LAYOUT_FILE"
            fi

            echo "Patched layout (preview):"
            sed -n '1,160p' "$LAYOUT_FILE" || true
          else
            echo "Warning: layout file not found at $LAYOUT_FILE; skipping patch"
          fi

      - name: Install dependencies (project)
        shell: bash
        run: |
          PROJECT_DIR="smart-crop-adviser/smart-crop-adviser/smart-crop-adviser"
          cd "$PROJECT_DIR"
          npm ci
        timeout-minutes: 10

      - name: Run Next.js build
        shell: bash
        run: |
          PROJECT_DIR="smart-crop-adviser/smart-crop-adviser/smart-crop-adviser"
          cd "$PROJECT_DIR"
          npm run build
        timeout-minutes: 20

      - name: Run export (if present)
        shell: bash
        run: |
          PROJECT_DIR="smart-crop-adviser/smart-crop-adviser/smart-crop-adviser"
          cd "$PROJECT_DIR"
          if npm run | sed -n '1,200p' | grep -q " export"; then
            npm run export
          else
            echo "No export script found â€” skipping export."
          fi
        timeout-minutes: 10

      - name: Verify artifacts
        shell: bash
        run: |
          PROJECT_DIR="smart-crop-adviser/smart-crop-adviser/smart-crop-adviser"
          cd "$PROJECT_DIR"
          if [ -d out ]; then
            echo "out/ exists:"
            ls -la out || true
          else
            echo "No out/ directory. Showing .next:"
            ls -la .next || true
          fi

      - name: Upload artifact for Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: smart-crop-adviser/smart-crop-adviser/smart-crop-adviser/out

  deploy:
    runs-on: ubuntu-latest
    needs: build-and-deploy
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to Pages
        id: deployment
        uses: actions/deploy-pages@v4
