name: Debug Next.js build - find package.json and list npm scripts

on:
  workflow_dispatch:
  push:
    branches: ["main"]

jobs:
  debug-build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository (full)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Show repo root and list top-level files
        run: |
          echo "Runner pwd: $(pwd)"
          echo "Listing root files:"
          ls -la

      - name: Find package.json (debug)
        id: findpkg
        run: |
          echo "Searching for package.json (maxdepth 6)..."
          FILE=$(find . -maxdepth 6 -type f -name package.json | sed -n '1p' || true)
          if [ -z "$FILE" ]; then
            echo "::error::No package.json found in repository (search depth 6)."
            exit 1
          fi
          echo "Found package.json at: $FILE"
          echo "path=$FILE" >> $GITHUB_OUTPUT

      - name: Show the found package.json path and directory
        run: |
          echo "package.json path: ${{ steps.findpkg.outputs.path }}"
          DIR=$(dirname "${{ steps.findpkg.outputs.path }}")
          echo "package.json dir: $DIR"
          echo "Listing files in that directory:"
          ls -la "$DIR"

      - name: Print package.json contents (for debug)
        run: |
          echo "---- package.json contents start ----"
          cat "${{ steps.findpkg.outputs.path }}" || true
          echo "---- package.json contents end ----"

      - name: Show npm available scripts (in package dir)
        run: |
          DIR=$(dirname "${{ steps.findpkg.outputs.path }}")
          echo "Running 'npm --version' and 'node --version'"
          npm --version
          node --version
          echo "Listing npm scripts (npm run) in $DIR"
          (cd "$DIR" && npm run) || true

      - name: Install dependencies (in package dir)
        if: ${{ always() }}
        run: |
          DIR=$(dirname "${{ steps.findpkg.outputs.path }}")
          echo "Installing dependencies in $DIR"
          cd "$DIR"
          npm ci
        working-directory: ${{ github.workspace }}

      - name: Attempt build (only if build script exists)
        run: |
          DIR=$(dirname "${{ steps.findpkg.outputs.path }}")
          echo "Checking for build script in package.json..."
          if (cd "$DIR" && node -e "const p=require('./package.json'); console.log(Boolean(p.scripts && p.scripts.build));"); then
            echo "build script present — running npm run build"
            cd "$DIR"
            npm run build
          else
            echo "::error::No build script present in $DIR/package.json — aborting build step."
            exit 1
          fi
        working-directory: ${{ github.workspace }}
