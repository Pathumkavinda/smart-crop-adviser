name: Fix CSS-module & Deploy Next.js to GitHub Pages

on:
  push:
    branches: ["main"]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Prepare files (install raw-loader, add next.config, add injector, patch layout)
        run: |
          set -euo pipefail

          # move to the project folder (adjust if your project root is different)
          PROJECT_DIR="./smart-crop-adviser/smart-crop-adviser/smart-crop-adviser"
          echo "Project dir: $PROJECT_DIR"
          cd "$PROJECT_DIR"

          echo "Installing raw-loader as dev dependency (for this runner)..."
          # install raw-loader locally for the build (does not commit)
          npm install --no-audit --no-fund --save-dev raw-loader

          echo "Writing next.config.js to instruct webpack to load home.module.css as raw text..."
          cat > next.config.js <<'JS'
module.exports = {
  webpack: (config) => {
    config.module.rules.push({
      test: /[\\/]src[\\/]app[\\/]home\.module\.css$/,
      use: [
        {
          loader: require.resolve('raw-loader'),
        },
      ],
    });
    return config;
  },
};
JS

          echo "Creating client injector component at src/components/InjectHomeCss.jsx..."
          mkdir -p src/components
          cat > src/components/InjectHomeCss.jsx <<'JSX'
'use client';

import { useEffect } from 'react';
import cssText from '../app/home.module.css';

export default function InjectHomeCss() {
  useEffect(() => {
    if (typeof document === 'undefined') return;
    const ID = 'injected-home-module-css';
    if (document.getElementById(ID)) return;

    const style = document.createElement('style');
    style.id = ID;
    style.type = 'text/css';
    style.appendChild(document.createTextNode(cssText));
    document.head.appendChild(style);
  }, []);

  return null;
}
JSX

          # Patch layout.js: replace the CSS import with injector import, and inject component into body
          LAYOUT="src/app/layout.js"
          if [ -f "$LAYOUT" ]; then
            echo "Patching $LAYOUT"
            # Replace the import line for home.module.css with injector import.
            # If the import exists as `import './home.module.css';` (exact), replace it.
            # Otherwise try to remove any import that references home.module.css and add injector import.
            if grep -q "import './home.module.css'" "$LAYOUT"; then
              sed -i "s|import './home.module.css';|import InjectHomeCss from '../components/InjectHomeCss';|g" "$LAYOUT"
            else
              # remove any import lines that mention home.module.css
              sed -i "/home.module.css/d" "$LAYOUT" || true
              # ensure injector import exists after other imports
              sed -i "1,/import .* from .*;/!b; /import .* from .*;/!b; a\\
import InjectHomeCss from '../components/InjectHomeCss';
" "$LAYOUT" || true
            fi

            # Insert the <InjectHomeCss /> component immediately after the opening <body ...> tag
            # Only add if not already present.
            if ! grep -q "InjectHomeCss" "$LAYOUT"; then
              # Add the component line after the body opening tag
              sed -i "s|<body\\(.*\\)>|<body\\1>\\n        <InjectHomeCss />|g" "$LAYOUT"
            fi

            echo "Patched layout (first 120 lines):"
            sed -n '1,120p' "$LAYOUT" || true
          else
            echo "WARNING: layout file not found at $LAYOUT - skipping patch"
          fi

      - name: Install dependencies
        run: |
          PROJECT_DIR="./smart-crop-adviser/smart-crop-adviser/smart-crop-adviser"
          cd "$PROJECT_DIR"
          npm ci
        timeout-minutes: 10

      - name: Build Next.js
        run: |
          PROJECT_DIR="./smart-crop-adviser/smart-crop-adviser/smart-crop-adviser"
          cd "$PROJECT_DIR"
          echo "Running npm run build..."
          npm run build
        timeout-minutes: 20

      - name: Export (produce ./out)
        run: |
          PROJECT_DIR="./smart-crop-adviser/smart-crop-adviser/smart-crop-adviser"
          cd "$PROJECT_DIR"
          # attempt a static export; if export script missing, skip gracefully
          if npm run | sed -n '1,200p' | grep -q " export"; then
            npm run export
          else
            echo "No export script found â€” skipping export. If your site is not exportable, GitHub Pages cannot serve it."
          fi
        timeout-minutes: 10

      - name: Verify out path and show listing
        run: |
          PROJECT_DIR="./smart-crop-adviser/smart-crop-adviser/smart-crop-adviser"
          cd "$PROJECT_DIR"
          if [ -d out ]; then
            echo "Found out/ directory:"
            ls -la out || true
          else
            echo "No out/ directory found. Showing .next (if any):"
            ls -la .next || true
            echo "If no out/ produced, GitHub Pages will not be able to serve this app (requires static export)."
          fi

      - name: Upload artifact (Pages)
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./smart-crop-adviser/smart-crop-adviser/smart-crop-adviser/out

  deploy:
    runs-on: ubuntu-latest
    needs: build-and-deploy
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
