name: Fix CSS-module -> global CSS & Deploy Next.js to GitHub Pages

on:
  push:
    branches: ["main"]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node 20
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Detect Next.js project directory
        id: detect
        shell: bash
        run: |
          set -euo pipefail
          repo_root="${GITHUB_WORKSPACE:-.}"
          echo "Repo root: $repo_root"
          # find package.json files excluding node_modules
          mapfile -t pkgs < <(find "$repo_root" -type d -name node_modules -prune -o -type f -name 'package.json' -print 2>/dev/null || true)
          if [ ${#pkgs[@]} -eq 0 ]; then
            echo "ERROR: no package.json found" >&2
            exit 1
          fi
          chosen=""
          for p in "${pkgs[@]}"; do
            if grep -q '"next"' "$p" || grep -q '"next":' "$p"; then
              chosen="$p"
              break
            fi
          done
          if [ -z "$chosen" ]; then
            chosen="${pkgs[0]}"
            echo "No package.json with 'next' found; using first: $chosen" >&2
          else
            echo "Selected Next.js package.json: $chosen" >&2
          fi
          proj_dir=$(dirname "$chosen")
          # make proj_dir relative to repo root
          rel_proj_dir="${proj_dir#$repo_root/}"
          if [ -z "$rel_proj_dir" ] || [ "$rel_proj_dir" = "$repo_root" ]; then
            rel_proj_dir="."
          fi
          echo "project_dir=$rel_proj_dir" >> $GITHUB_OUTPUT

      - name: Make runner-safe CSS change (rename module -> global) and patch layout
        shell: bash
        run: |
          set -euo pipefail
          PROJECT_DIR="${{ steps.detect.outputs.project_dir }}"
          echo "Project dir (relative): $PROJECT_DIR"
          cd "$PROJECT_DIR"

          SRC="src/app/home.module.css"
          DST="src/app/home.css"

          if [ -f "$SRC" ]; then
            echo "Renaming $SRC -> $DST (runner only)"
            mv -f "$SRC" "$DST"
          else
            echo "No $SRC found; skipping rename"
          fi

          LAYOUT="src/app/layout.js"
          if [ -f "$LAYOUT" ]; then
            echo "Patching $LAYOUT imports to use './home.css' instead of module"

            # backup
            cp "$LAYOUT" "${LAYOUT}.bak"

            # remove any lines that reference home.module.css
            grep -v "home.module.css" "${LAYOUT}.bak" > "${LAYOUT}.tmp" || true
            mv -f "${LAYOUT}.tmp" "$LAYOUT"

            # ensure import './home.css' exists â€” insert after last import line
            if ! grep -q "import './home.css'" "$LAYOUT"; then
              last_import_line=$(grep -n '^import ' "$LAYOUT" | tail -n1 | cut -d: -f1 || echo 0)
              if [ "$last_import_line" -gt 0 ]; then
                awk -v n="$last_import_line" 'NR==n{print; print "import '\''./home.css'\'';"; next} NR!=n{print}' "$LAYOUT" > "${LAYOUT}.tmp" && mv "${LAYOUT}.tmp" "$LAYOUT"
              else
                sed -i "1s;^;import './home.css';\n;" "$LAYOUT"
              fi
            fi

            echo "Patched layout (preview):"
            sed -n '1,200p' "$LAYOUT" || true
          else
            echo "Layout not found at $LAYOUT; skipping patch"
          fi

      - name: Fix dynamic routes for static export
        shell: bash
        run: |
          set -euo pipefail
          PROJECT_DIR="${{ steps.detect.outputs.project_dir }}"
          cd "$PROJECT_DIR"

          # Find and fix the dynamic route page
          DYNAMIC_PAGE="src/app/adviser/history/[id]/page.js"
          
          if [ -f "$DYNAMIC_PAGE" ]; then
            echo "Found dynamic route at $DYNAMIC_PAGE"
            
            # Check if generateStaticParams already exists
            if ! grep -q "generateStaticParams" "$DYNAMIC_PAGE"; then
              echo "Adding generateStaticParams function"
              
              # Backup original
              cp "$DYNAMIC_PAGE" "${DYNAMIC_PAGE}.bak"
              
              # Add generateStaticParams at the beginning of the file (after imports)
              cat > "${DYNAMIC_PAGE}.tmp" << 'EOF'
// Generate static params for all possible IDs
export async function generateStaticParams() {
  // Return empty array to generate no static pages at build time
  // This allows the route to work with dynamic rendering
  // If you have specific IDs, return them like: return [{ id: '1' }, { id: '2' }]
  return [];
}

EOF
              cat "$DYNAMIC_PAGE" >> "${DYNAMIC_PAGE}.tmp"
              mv "${DYNAMIC_PAGE}.tmp" "$DYNAMIC_PAGE"
              
              echo "Added generateStaticParams to $DYNAMIC_PAGE"
            else
              echo "generateStaticParams already exists in $DYNAMIC_PAGE"
            fi
          else
            echo "Dynamic route not found at expected path: $DYNAMIC_PAGE"
            echo "Searching for dynamic routes..."
            find src/app -type f -name "page.js" -path "*/\[*\]/*" || true
          fi

      - name: Install dependencies (project)
        shell: bash
        run: |
          set -euo pipefail
          cd "${{ steps.detect.outputs.project_dir }}"
          npm ci
        timeout-minutes: 10

      - name: Build Next.js
        shell: bash
        run: |
          set -euo pipefail
          cd "${{ steps.detect.outputs.project_dir }}"
          npm run build
        timeout-minutes: 20

      - name: Export static site if available
        shell: bash
        run: |
          set -euo pipefail
          cd "${{ steps.detect.outputs.project_dir }}"
          if npm run | sed -n '1,200p' | grep -q " export"; then
            npm run export
          else
            echo "No export script; skipping export"
          fi
        timeout-minutes: 10

      - name: Show artifacts
        shell: bash
        run: |
          set -euo pipefail
          cd "${{ steps.detect.outputs.project_dir }}"
          if [ -d out ]; then
            echo "out/ exists:"
            ls -la out
          else
            echo "No out/ - listing .next:"
            ls -la .next || true
          fi

      - name: Upload Pages artifact (if exists)
        uses: actions/upload-pages-artifact@v3
        with:
          path: ${{ steps.detect.outputs.project_dir }}/out

  deploy:
    runs-on: ubuntu-latest
    needs: build-and-deploy
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to Pages
        id: deployment
        uses: actions/deploy-pages@v4
