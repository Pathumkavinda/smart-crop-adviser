name: Fix home.module.css import (rename to global) & Deploy Next.js to GitHub Pages

on:
  push:
    branches: ["main"]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node 20
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Prepare project (rename module css -> global css & patch layout)
        shell: bash
        run: |
          set -euo pipefail

          # Adjust this to your actual Next.js project folder if different
          PROJECT_DIR="smart-crop-adviser/smart-crop-adviser/smart-crop-adviser"
          echo "Project dir: $PROJECT_DIR"

          if [ ! -d "$PROJECT_DIR" ]; then
            echo "ERROR: project dir does not exist: $PROJECT_DIR"
            ls -la
            exit 1
          fi

          cd "$PROJECT_DIR"

          SRC_CSS="src/app/home.module.css"
          DST_CSS="src/app/home.css"

          if [ -f "$SRC_CSS" ]; then
            echo "Renaming $SRC_CSS -> $DST_CSS (in runner only)"
            mkdir -p "$(dirname "$DST_CSS")"
            mv -f "$SRC_CSS" "$DST_CSS"
          else
            echo "Note: $SRC_CSS not found; skipping rename"
          fi

          LAYOUT="src/app/layout.js"
          if [ -f "$LAYOUT" ]; then
            echo "Patching layout import in $LAYOUT"
            # Replace any import of home.module.css with global import home.css
            # Handle different possible import syntaxes conservatively.
            sed -i "s|import .*home.module.css.*;|import './home.css';|g" "$LAYOUT" || true

            # If injector or other lines accidentally added earlier exist, remove them
            sed -i "/InjectHomeCss/d" "$LAYOUT" || true

            # Show preview
            sed -n '1,200p' "$LAYOUT" || true
          else
            echo "Warning: layout file $LAYOUT not found; skipping patch"
          fi

      - name: Install dependencies (project)
        shell: bash
        run: |
          PROJECT_DIR="smart-crop-adviser/smart-crop-adviser/smart-crop-adviser"
          cd "$PROJECT_DIR"
          npm ci
        timeout-minutes: 10

      - name: Run Next.js build
        shell: bash
        run: |
          PROJECT_DIR="smart-crop-adviser/smart-crop-adviser/smart-crop-adviser"
          cd "$PROJECT_DIR"
          npm run build
        timeout-minutes: 20

      - name: Run export (if present)
        shell: bash
        run: |
          PROJECT_DIR="smart-crop-adviser/smart-crop-adviser/smart-crop-adviser"
          cd "$PROJECT_DIR"
          if npm run | sed -n '1,200p' | grep -q " export"; then
            npm run export
          else
            echo "No export script found â€” skipping export."
          fi
        timeout-minutes: 10

      - name: Verify artifacts
        shell: bash
        run: |
          PROJECT_DIR="smart-crop-adviser/smart-crop-adviser/smart-crop-adviser"
          cd "$PROJECT_DIR"
          if [ -d out ]; then
            echo "out/ exists:"
            ls -la out || true
          else
            echo "No out/ directory. Showing .next:"
            ls -la .next || true
          fi

      - name: Upload artifact for Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: smart-crop-adviser/smart-crop-adviser/smart-crop-adviser/out

  deploy:
    runs-on: ubuntu-latest
    needs: build-and-deploy
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to Pages
        id: deployment
        uses: actions/deploy-pages@v4
