name: Deploy Next.js (CI ESLint disabled) to GitHub Pages

on:
  push:
    branches: ["main"]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Detect Next.js project directory
        id: detect
        shell: bash
        run: |
          set -euo pipefail
          repo_root="${GITHUB_WORKSPACE:-.}"
          echo "Repo root: $repo_root"
          # find package.json files excluding node_modules
          mapfile -t pkgs < <(find "$repo_root" -type d -name node_modules -prune -o -type f -name 'package.json' -print 2>/dev/null || true)
          if [ ${#pkgs[@]} -eq 0 ]; then
            echo "ERROR: no package.json found" >&2
            exit 1
          fi
          chosen=""
          for p in "${pkgs[@]}"; do
            if grep -q '"next"' "$p" || grep -q '"next":' "$p"; then
              chosen="$p"
              break
            fi
          done
          if [ -z "$chosen" ]; then
            chosen="${pkgs[0]}"
            echo "No package.json with 'next' found; using first: $chosen" >&2
          else
            echo "Selected Next.js package.json: $chosen" >&2
          fi
          proj_dir=$(dirname "$chosen")
          # make proj_dir relative to repo root
          rel_proj_dir="${proj_dir#$repo_root/}"
          if [ -z "$rel_proj_dir" ] || [ "$rel_proj_dir" = "$repo_root" ]; then
            rel_proj_dir="."
          fi
          echo "project_dir=$rel_proj_dir" >> "$GITHUB_OUTPUT"

      - name: Disable ESLint during build (runner-only next.config.js)
        shell: bash
        run: |
          set -euo pipefail
          cd "${{ steps.detect.outputs.project_dir }}"
          # backup if exists
          if [ -f next.config.js ]; then
            cp next.config.js next.config.js.bak || true
            cat > next.config.js <<'JS'
/**
 * Runner-only next.config.js wrapper created by CI to ignore ESLint during builds.
 * It merges the user's original config (next.config.js.bak) and forces eslint.ignoreDuringBuilds = true.
 */
const userConfig = (() => {
  try {
    return require('./next.config.js.bak') || {};
  } catch (e) {
    return {};
  }
})();
const merged = Object.assign({}, userConfig, {
  eslint: Object.assign({}, (userConfig.eslint || {}), { ignoreDuringBuilds: true })
});
module.exports = merged;
JS
          else
            cat > next.config.js <<'JS'
/** Runner-only next.config.js to skip ESLint during builds */
module.exports = {
  eslint: {
    ignoreDuringBuilds: true
  }
};
JS
          fi
          echo "next.config.js written (runner-only)"
          sed -n '1,200p' next.config.js || true

      - name: Install dependencies (project)
        shell: bash
        run: |
          set -euo pipefail
          cd "${{ steps.detect.outputs.project_dir }}"
          npm ci
        timeout-minutes: 10

      - name: Build Next.js (ESLint disabled in runner)
        shell: bash
        run: |
          set -euo pipefail
          cd "${{ steps.detect.outputs.project_dir }}"
          npm run build
        timeout-minutes: 20

      - name: Export static site if available
        shell: bash
        run: |
          set -euo pipefail
          cd "${{ steps.detect.outputs.project_dir }}"
          if npm run | sed -n '1,200p' | grep -q " export"; then
            npm run export
          else
            echo "No export script found â€” skipping export."
          fi
        timeout-minutes: 10

      - name: Upload Pages artifact (if out exists)
        uses: actions/upload-pages-artifact@v3
        with:
          path: ${{ steps.detect.outputs.project_dir }}/out

  deploy:
    runs-on: ubuntu-latest
    needs: build-and-deploy
    environment:
      name: github-pages
      # page_url available after deploy step; left empty here
      url: ''
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
