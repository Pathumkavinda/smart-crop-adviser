name: Deploy Next.js site to Pages

on:
  push:
    branches: ["main"]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Detect Next.js project & package manager
        id: detect
        run: |
          set -euo pipefail
          repo_root="${GITHUB_WORKSPACE:-.}"
          echo "Debug: GITHUB_WORKSPACE=$repo_root" >&2

          # Find candidate package.json files (exclude node_modules)
          mapfile -t pkg_files < <(find "$repo_root" -type d -name node_modules -prune -o -type f -name 'package.json' -print 2>/dev/null || true)

          if [ ${#pkg_files[@]} -eq 0 ]; then
            echo "No package.json found in repository (excluding node_modules)." >&2
            exit 1
          fi

          chosen=""
          # Prefer package.json that depends on 'next'
          for pkg in "${pkg_files[@]}"; do
            if grep -q '"next"' "$pkg" || grep -q '"next":' "$pkg"; then
              chosen="$pkg"
              break
            fi
          done

          # fall back to the first package.json if none contained next
          if [ -z "$chosen" ]; then
            chosen="${pkg_files[0]}"
            echo "No package.json with 'next' found; using first package.json: $chosen" >&2
          else
            echo "Selected package.json with 'next': $chosen" >&2
          fi

          project_dir=$(dirname "$chosen")
          # detect lockfile in that project dir
          if [ -f "$project_dir/yarn.lock" ]; then
            manager="yarn"
            install_cmd="yarn install --frozen-lockfile || yarn install"
            build_cmd="yarn build"
          elif [ -f "$project_dir/pnpm-lock.yaml" ]; then
            manager="pnpm"
            install_cmd="pnpm install"
            build_cmd="pnpm exec next build"
          elif [ -f "$project_dir/package-lock.json" ]; then
            manager="npm"
            install_cmd="npm ci"
            build_cmd="npm run build"
          else
            # default to npm if no lockfile present
            manager="npm"
            install_cmd="npm install"
            build_cmd="npm run build"
          fi

          echo "manager=$manager" >> $GITHUB_OUTPUT
          echo "project_dir=$project_dir" >> $GITHUB_OUTPUT
          # commands include cd into project dir for convenience
          echo "install_cmd=cd \"$project_dir\" && $install_cmd" >> $GITHUB_OUTPUT
          # run build, then attempt export if user has an 'export' script (don't fail on export)
          echo "build_cmd=cd \"$project_dir\" && $build_cmd && (npm run export || yarn export || pnpm exec next export || true)" >> $GITHUB_OUTPUT

      - name: Setup Node (no built-in cache)
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Cache package manager files
        uses: actions/cache@v4
        with:
          # key uses the lockfile if present under the detected project dir
          path: |
            ~/.npm
            ~/.cache/yarn
            ~/.pnpm-store
          key: ${{ runner.os }}-pkgcache-${{ steps.detect.outputs.manager }}-${{ hashFiles(format('{0}/**/package-lock.json', steps.detect.outputs.project_dir), format('{0}/**/yarn.lock', steps.detect.outputs.project_dir), format('{0}/**/pnpm-lock.yaml', steps.detect.outputs.project_dir)) }}
          restore-keys: |
            ${{ runner.os }}-pkgcache-${{ steps.detect.outputs.manager }}-

      - name: Cache .next
        uses: actions/cache@v4
        with:
          path: ${{ steps.detect.outputs.project_dir }}/.next/cache
          key: ${{ runner.os }}-nextjs-${{ hashFiles(format('{0}/**/package-lock.json', steps.detect.outputs.project_dir), format('{0}/**/yarn.lock', steps.detect.outputs.project_dir), format('{0}/**/pnpm-lock.yaml', steps.detect.outputs.project_dir)) }}-${{ hashFiles(format('{0}/**/*.[jt]s', steps.detect.outputs.project_dir)) }}
          restore-keys: |
            ${{ runner.os }}-nextjs-

      - name: Show selected project
        run: |
          echo "Detected manager: ${{ steps.detect.outputs.manager }}"
          echo "Detected project dir: ${{ steps.detect.outputs.project_dir }}"
          echo "Project package.json:"
          sed -n '1,200p' "${{ steps.detect.outputs.project_dir }}/package.json" || true

      - name: Install dependencies
        run: ${{ steps.detect.outputs.install_cmd }}
        timeout-minutes: 10

      - name: Build (and attempt export)
        run: |
          echo "Running: ${{ steps.detect.outputs.build_cmd }}"
          set -o pipefail
          bash -c "${{ steps.detect.outputs.build_cmd }}" | sed -u 's/^/[build] /'
        timeout-minutes: 20

      - name: Verify out/ or show .next
        run: |
          proj="${{ steps.detect.outputs.project_dir }}"
          if [ -d "$proj/out" ]; then
            echo "Static export produced at $proj/out"
            ls -la "$proj/out"
          else
            echo "No static ./out found. Listing $proj/.next (if present):"
            ls -la "$proj/.next" || true
            echo ""
            echo "If you want GitHub Pages to serve this site, ensure you create an 'export' script or produce static files into ./out."
            echo "Example package.json scripts for static export:"
            echo '  \"build\": \"next build\"'
            echo '  \"export\": \"next export\"'
          fi

      - name: Upload artifact for Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: ${{ steps.detect.outputs.project_dir }}/out

  deploy:
    runs-on: ubuntu-latest
    needs: build
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
